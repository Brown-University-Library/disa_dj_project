{% extends "disa_app_templates/editor.html" %}
{% load staticfiles %}


{# in <head> #}


{% block header_other %}
{% comment %} {{ super() }} {% endcomment %}

<link rel="stylesheet" href="{% static 'lib/bootstrap-4.1.2-dist/css/bootstrap.min.css' %}">

<style>

    p#document_header {
        font-style: italic;
        margin-top: .5em;
    }

    div.row {
        margin-top: -1em;
    }

    h1#doc_header {
        margin-top: .25em;
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 32px;
        font-weight: 500;
        line-height: 1.25;
        margin-right: 3em;
    }

    /***************************************************/
    /* `Document` and `Items` scss work-around styling *  TODO: undo all this, since the scss is now working again
    /***************************************************/

    .col, .col-1, .col-10, .col-11, .col-12, .col-2, .col-3, .col-4, .col-5, .col-6, .col-7, .col-8, .col-9, .col-auto, .col-lg, .col-lg-1, .col-lg-10, .col-lg-11, .col-lg-12, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-auto, .col-md, .col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-auto, .col-sm, .col-sm-1, .col-sm-10, .col-sm-11, .col-sm-12, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-auto, .col-xl, .col-xl-1, .col-xl-10, .col-xl-11, .col-xl-12, .col-xl-2, .col-xl-3, .col-xl-4, .col-xl-5, .col-xl-6, .col-xl-7, .col-xl-8, .col-xl-9, .col-xl-auto {
        position: relative;
        width: 100%;
        min-height: 1px;
        padding-right: 15px;
        padding-left: 15px;
    }

    a.title_link {
        float: right;
        margin-top: -2.3em;
    }

    p#items_header {
        font-style: italic;
    }

    hr#post_document {
        margin-top: -.5em;
    }


    input[type=text] {
        height: 2.5em;
        padding-left: .5em;
    }

    .alert-primary {
        color: #004085;
        background-color: #cce5ff;
        border-color: #b8daff;
    }

    .alert {
        position: relative;
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }

    *, ::after, ::before {
        box-sizing: border-box;
    }

    .form-group {
        margin-bottom: 1rem;
    }
    .row {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    label {
        display: inline-block;
        margin-top: 1rem;  /* not in scss -- custom addition to get spacing to look like S.M. page */
        margin-bottom: .5rem;
    }

    select.form-control:not([size]):not([multiple]) {
        height: calc(2.25rem + 2px);
    }

    .small, small {
        font-size: 80%;
        font-weight: 400;
    }

    .form-control {
        display: block;
        width: 100%;
        padding: .375rem .75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: .25rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    .btn:not(:disabled):not(.disabled) {
        cursor: pointer;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        border: 1px solid transparent;
        padding: .375rem .75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: .25rem;
        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    button, select {
        text-transform: none;
    }

    button, input {
        overflow: visible;
    }

    button, input, optgroup, select, textarea {
        margin: 0;
        /*font-family: inherit;*/
        font-family: 'Source Sans Pro', sans-serif;
        font-size: inherit;
        line-height: inherit;
    }

    button {
        border-radius: 0;
    }

    /* End of bootstrap-scss work-around. */

    span.click_message {
        font-size: 12px;
        font-weight: 300;
        font-style: italic;
    }

    hr#post_items {
        margin-top: 1.2em;
    }

    /*************************************/
    /* `People` scss work-around styling *  TODO: undo all this, since the scss is now working again
    /*************************************/

    .h2, h2 {
        font-size: 2rem;
        margin-top: ,5em;
        margin-bottom: .5rem;
        /*font-family: inherit;*/
        font-family: 'Source Sans Pro', sans-serif;
        font-weight: 500;
        line-height: 1.2;
        color: inherit;
    }

    .table {
        width: 100%;
        max-width: 100%;
        margin-bottom: 1rem;
        background-color: transparent;

        border-collapse: collapse;
    }

    .table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
    }

    .table td, .table th {
        padding: .75rem;
        /*vertical-align: top;*/
        border-top: 1px solid #dee2e6;
    }

    .form-control:disabled, .form-control[readonly] {
        background-color: #e9ecef;
        opacity: 1;
    }

    .form-control {
        display: block;
        width: 100%;
        padding: .375rem .75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        /*background-color: #fff;*/
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: .25rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .entrant-ctl {
        margin-right: 5px;
    }

    [hidden] {
        display: none!important;
    }

    caption {
      caption-side:top;
      font-weight: bold;
      font-size: 120%;
      font-style: italic;
    }

    /* END of `People` scss work-around styling */

    span#people_explanation {
        font-size: 12px;
        font-weight: 300;
        font-style: italic;
    }

    .flex-row-reverse {
        /*-ms-flex-direction: row-reverse!important;*/
        flex-direction: row-reverse!important;
    }

    .d-flex {
        /*display: -ms-flexbox!important;*/
        display: flex!important;
    }

    /* GROUP MAGAEMENT INTERFACE STYLES */

    /* Hide edit controls unless in edit mode */

    tr.group-edit-entry {
      display: none;
    }

    tbody.group-edit-mode tr.group-edit-entry {
      display: table-row;
    }

    tbody.group-edit-mode tr.group-display-entry {
      display: none;
    }

    .groups-count {
      width: 5em;
      display: inline;
    }

    #groups-table label, #groups-table label input {
      display: inline
    }

    /* Hide "saving ..." notification unless saving */

    .group-save-state .saving-group {
      display: none;
    }

    .group-save-state.group-currently-saving .saving-group {
      display: initial;
    }

    .group-save-state.group-currently-saving .save-group {
      display: none;
    }


</style>

<!-- tinymce should load here -->
{% comment %}<script src="{{ url_for('static', filename='lib/tinymce/tinymce.js') }}"></script>{% endcomment %}
<script src="{% static 'lib/tinymce/tinymce.js' %}"></script>

{% endblock %}


{# in <body> #}


{% block content %}
<!-- <div class="container"> -->
<div class="container-fluid">

    <p id="document_header">Document... </span></p>
    <div class="row">
        <div class='col-md-11'>
            <h1 id="doc_header">{{ doc_display }}</h1>
            <a class="title_link" href="{% url 'edit_citation_url' doc_id %}">(edit document)</a>
        </div>
        {% comment %}
        <!--
          <div class='col-md-1'>
              <a href="{% url 'edit_citation_url' doc_id %}">Back</a>
          </div> -->
        {% endcomment %}
    </div>
    <hr id="post_document"> </hr>

    <p id="items_header">Item... {% if rec_id %}<span class="click_message">(item/record id: "{{rec_id}}")</span>{% endif %} <span class="click_message">(click to open/close)</span></p>
    <div id="record_form">
        <h2 id="record_header"></h2>
        <form action="" method="">
            <div class="alert alert-primary">
                    <strong>Please record information based on what is written in the document, rather than interpreting the text.</strong><br />
                    For example, if a location is identified as "Charles-Town" in the document, please preserve the spelling rather than modernizing to "Charleston."
            </div>
            <div class="form-group row">
                <label for="recordtype_autocomplete">Type<br />
                    <em class="small">Enter the type of item within the document that you’re adding. Use the drop down menu to see a list of options.</em></label>
                <input class="form-control" data-rectype-id="" type="text" id="recordtype_autocomplete"/>
            </div>
            <div class="form-group row">
                <label for="national_context">National Context<br />
                    <em class="small">Can be either a European nation or empire (e.g. Spanish, English, Dutch)</em></label>
                <select class="form-control" id="national_context">
                </select>
            </div>
            <div class="form-group row">
                <label for="col_state_autocomplete">Colony/State<br />
                    <em class="small">If the item lists a state or colony, write it here. Use the drop down menu to see a list of options.<br/>
                    Please write out the full name&mdash;e.g. enter "Rhode Island", not "RI".</em></label>
                <input class="form-control location-input" type="text" id="col_state_autocomplete" data-loc-id=""/>
            </div>
            <div class="form-group row">
                <label for="town_autocomplete">Town<br />
                    <em class="small">If there is a town listed in the item, write the name of the town here. </em></label>
                <input class="form-control location-input" type="text" id="town_autocomplete" data-loc-id=""/>
            </div>
            <div class="form-group row">
                <label for="addl_loc_autocomplete">Additional location<br />
                    <em class="small">If there are additional locations listed in the item, enter them here (e.g. “the dock”)</em></label>
                <input class="form-control location-input" type="text" id="addl_loc_autocomplete" data-loc-id=""/>
            </div>
            <div class="form-group row">
                <label for="record_date">Event date<br />
                    <em class="small">Enter the date of the events described in the item, <strong>not</strong> the publication date of the containing document</em></label>
                <input class="form-control" type="text" id="record_date" />
            </div>
            <div class="form-group row">
                <label for="transcription">Transcription<br />
                    <em class="small">Write the full text of the item in this field, as close as possible to the original (e.g. using original spelling, etc.)</em></label>
                    <br />
                <textarea class="form-control" id="transcription"></textarea>
            </div>

            <div class="form-group row">
                <label for="image_url">Image<br />
                    <em class="small">
                      Paste the full URL of the image associated with this item. The image should be
                      located in <a href="https://drive.google.com/drive/u/1/folders/1iEoQGjFo6ft-Vhzs9yaJytpt4KNmZv_L">this Google Drive folder</a>.
                      In Google Drive, right-click on the file and select "Get link," and in the pop-up, clock on "Copy link." Then paste into the field below.
                    </em></label>
                    <br />
                <input class="form-control" id="image_url"
                       placeholder="https://drive.google.com/file/d/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/view?usp=sharing"></input>
                 <div class="alert alert-danger" id="url-error-message" role="alert" hidden>
                    Not a valid URL!
                 </div>
            </div>
            <button type="submit" class="btn btn-primary" id="rec_update">
                Update
            </button>
        </form>
    </div>
    <hr id="post_items"></hr>

    {% if rec_id %}
    <h2>People <span id="people_explanation">(referenced in "Item..." above)</span></h2>
    <div id="entrant_component">
        {% comment %}
        <!--
        <div class="d-flex flex-row-reverse">
          <p><a href="{{ url_for('edit_relationships', recId=rec.id)}}">Manage relationships</a></p>
        </div>
        -->
        {% endcomment %}

        <div id="new_person_button" class="d-flex flex-row"
              style="margin: 1em 0">
            <button class="btn btn-primary" id="add-person">Add an individual</button>&nbsp;&nbsp;
            <button class="btn btn-primary add-group-selector" id="add-group">Add a group</button>&nbsp;&nbsp;
            <a class="btn btn-primary" href="{% url 'edit_relationships_url' rec_id %}">Identify connections between people</a>
        </div>
        <table class="table" id="entrants-table" hidden="hidden">
            <caption>
              Individuals
            </caption>
            <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col" style="width:25%">First</th>
                  <th scope="col" style="width:25%">Last</th>
                  <th scope="col" style="width:25%">Description</th>
                  <th scope="col"></th>
                </tr>
            </thead>
            <tbody id="entrants">
            </tbody>
        </table>
      </div>

      <div id="group_component">

        <!-- Groups delete confirmation modal -->

        <div class="modal fade" id="confirmDelete" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">
                  Please confirm that you want to delete this group
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <!--
              <div class="modal-body">
                No turning back!
              </div> -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="confirmDelete-no">Cancel delete</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="confirmDelete-yes">YES, delete!</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Groups table -->

        <table class="table" id="groups-table" hidden="hidden">
            <caption>
              Groups
              {% comment %} <!-- NOT SURE THIS IS NECESSARY (uncomment to reactivate)
              <button class="btn btn-primary btn-sm add-group-selector float-right">Add new</button> -->
              {% endcomment %}
            </caption>
            <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Description</th>
                  <th scope="col">Count</th>
                  <th scope="col"></th>
                </tr>
            </thead>
        </table>

        <!-- Groups entry template -->

        <template id="groups-template">
          <tbody>
            <!-- Group data row when in edit mode -->
            <tr class="group-edit-entry">
              <!-- Group ID -->
              <td>
                <a class="groups-id" href="" data-uuid=""
                   title="Copy group ID to clipboard"></a>
              </td>
              <!-- Group description -->
              <td>
                <textarea class="form-control group-input groups-description"
                      type="text" placeholder="Description from source"></textarea>
              </td>
              <td>
                  <!-- Group count -->
                  <input class="form-control group-input groups-count"
                         type="number" value="2" min="2"></input>
                  <!-- Group count estimated checkbox -->
                  <label>
                      <input class="group-input groups-count-estimated"
                      type="checkbox"></input>
                      Estimated
                  </label>
              </td>
              <td class="group-controls">
                <span class="group-save-state">
                  <!-- Group approve change button -->
                  <button class="btn btn-primary save-group entrant-ctl">
                    Save
                  </button>
                  <!-- Group in-process save button -->
                  <button class="btn btn-primary saving-group entrant-ctl">
                    Saving &hellip;
                  </button>
                </span>
                  <!-- Group undo change button -->
                  <button class="btn btn-secondary cancel-group entrant-ctl"
                          title="Cancel current changes">
                    Undo changes
                  </button>
                  <!-- Group delete button -->
                  <button class="btn btn-danger del-group group-ctl" title="Delete entry for this person"
                          data-toggle="modal" data-target="#confirmDelete">
                    Delete group
                  </button>
              </td>
            </tr>
            <!-- Group data row when in display mode -->
            <tr class="group-display-entry">
                <!-- Group ID -->
                <td>
                  <a  class="groups-id" href="" data-uuid=""
                      title="Copy group ID to clipboard"></a>
                </td>
                <!-- Group description -->
                <td>
                  <textarea class="form-control group-input groups-description click-to-edit-group"
                            type="text" readonly="true" placeholder="Description from source"></textarea>
                </td>
                <td>
                    <!-- Group count -->
                    <input class="form-control group-input groups-count click-to-edit-group"
                           type="number" readonly="true"></input>
                    <!-- Group count estimated checkbox -->
                    <label>
                      <input class="group-input groups-count-estimated click-to-edit-group"
                      type="checkbox" readonly="true"></input>
                      Estimated
                  </label>
                </td>
                <td class="group-controls">
                  <button class="btn btn-primary edit-group group-ctl click-to-edit-group">
                    Edit
                  </button>
                </td>
            </tr>
          </tbody>
        </template>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts%}
{% comment %} {{ super() }} {% endcomment %}
{{ block.super }}

<script id="towns_id" type="application/json">{{ towns|safe }}</script>

<script id="addl_loc_id" type="application/json">{{ addl_loc|safe }}</script>


<script>

// onlick handler for ID links -- copies URL (including UUID)
//  to clipboard

function copyUUIDtoClipboard(e) {
  console.log( "initial built url, ", e.target.href );
  e.preventDefault();
  navigator.permissions.query({name: 'clipboard-write'}).then(result => {
    if (result.state == 'granted' || result.state == 'prompt') {
      navigator.clipboard.writeText(e.target.href);
      const oldText = e.target.innerHTML;
      e.target.innerHTML = 'ID copied';
      window.setTimeout(
        () => e.target.innerHTML = oldText,
        2000
      );
    }
  });
}

var getDocumentId = function () {
    {% comment %} var doc_id = "{{ doc.id or '' }}"; {% endcomment %}
    {% if doc_id %}
        var doc_id = "{{ doc_id }}";
    {% else %}
        var doc_id = "";
    {% endif %}
    return doc_id;
}

var getRecId = function () {
    {% comment %} var rec_id = "{{ rec.id or '' }}"; {% endcomment %}
    {% if rec_id %}
        var rec_id = "{{ rec_id }}";
    {% else %}
        var rec_id = "";
    {% endif %}
    return rec_id;
}

var updateLocationInputs = function (locsArray) {
    var col_state,
        town, addl_loc,
        loc_inputs;
    col_state = $('#col_state_autocomplete');
    town = $('#town_autocomplete');
    addl_loc = $('#addl_loc_autocomplete');
    loc_inputs = [col_state, town, addl_loc];
    for ( var i=0; i < locsArray.length; i++ ) {
        var loc_data, loc_input;

        loc_data = locsArray[i];
        loc_input = loc_inputs[i];
        loc_input.val(loc_data.value);
        loc_input.attr('data-loc-id', loc_data.id);
    }
}

var setInputValues = function(recData) {

    /*
      Updates input fields from readRecordData() api call
      when initializing form, and from ajax-update from when
      data is updated.

      Called by initializeForm() and updateRecordData()
    */

    console.log( "in setInputValues; will update item fields." )
    if ( $.isEmptyObject(recData) ) {
        return;
    }
    $('#transcription').text(recData['transcription']);
    tinymce.get('transcription').setContent(recData['transcription']);
    $('#record_date').val(recData['date']);
    updateLocationInputs(recData['locations']);
    updateRecordType($('#recordtype_autocomplete'), recData['record_type']);
    updateNationalContext($('#national_context'), recData['national_context']);
    updateImageUrl(document.getElementById('image_url'), recData['image_url']);
}

const updateImageUrl = function(input, data) {
  if (data) {
    try {
      const validUrl = (new URL(new String(data))).href;
      input.value = validUrl;
    } catch (_) {
      console.error(`WARNING: provided image URL ${dataAsString} is not valid`);
    }
  }
}

var updateRecordType = function ($input, data) {
    if ( $.isEmptyObject(data) ) {
        $input.attr('data-rectype-id', '');
        $input.val = '';
    } else {
        $input.attr('data-rectype-id', data.id);
        $input.val(data.value);
    }
}

var updateNationalContext = function ($select, data) {
    if ( data === '')  {
        $select.val(null);
    } else {
        $select.val(data);
    }
}

var updateLocationInput = function ($input, data) {
    if ( $.isEmptyObject(data) ) {
        $input.attr('data-loc-id', '');
        $input.val = '';
    } else {
        $input.attr('data-loc-id', data.id);
        $input.val(data.value);
    }
}

var collectLocations = function() {
    var locArray = [];
    $(".location-input").each( function( idx ) {
        var locData = {}
        locData['id'] = Number( $(this).attr('data-loc-id') );
        var loc_name = $(this).val();
        if (loc_name && locData['id'] == 0) {
            locData['id'] = -1;
        } else if (locData['id'] == 0) {
            return true;
        }
        locData['label'] = loc_name;
        locData['value'] = loc_name;
        locArray.push(locData);
    });
    return locArray;
}

var collectInputValues = function(docId) {
    var data = {};
    console.log( "about to log perceived transcription" );
    data['transcription'] = $('#transcription').val();
    console.log( "perceived transcription, ", data['transcription'] );
    data['record_type'] =  {
        'id': Number( $('#recordtype_autocomplete').attr('data-rectype-id') ),
        'value': $('#recordtype_autocomplete').val(),
        'label': $('#recordtype_autocomplete').val()
    }
    data['national_context'] =  Number( $('#national_context').val() );
    data['locations'] = collectLocations();
    data['date'] = $('#record_date').val();
    data['citation_id'] = Number(docId);

    try { // Only load image_url if it's a valid URL
      data['image_url'] = (new URL($('#image_url').val())).href;
      document.getElementById('url-error-message').setAttribute('hidden', 'hidden');
    } catch (_) {
      document.getElementById('url-error-message').removeAttribute('hidden');
    }

    return data;
}

var addTypeOptions = function(opts) {
    var rtype_select = $('#record_type');
    rtype_select.empty();
    for (var i = 0; i < opts.length; i++) {
        var opt = opts[i];
        var opt_elem = $("<option/>", { 'value': opt.id ,
                                        'text': opt.name });
        rtype_select.append(opt_elem);
    }
}

var addNationalContextOptions = function(opts) {
    var natl_ctx_select = $('#national_context');
    natl_ctx_select.empty();
    for (var i = 0; i < opts.length; i++) {
        var opt = opts[i];
        var opt_elem = $("<option/>", { 'value': opt.id ,
                                        'text': opt.name });
        natl_ctx_select.append(opt_elem);
    }
}

var setFormHeader = function (recData) {
    console.log( "in setFormHeader; recData: ", recData )
    var header, header_txt = '';
    header = $('#record_header');
    if ( $.isEmptyObject(recData) ) {
        header.html('Add new item<br /><em>An "item" is a description of one or more people (with their relationship) that appears in the document.<br />There may be associated time and place information&mdash;for example, if the item describes an event.</em>');
        $('#rec_update').text('Create');
    } else {
        header.text(recData['header']);
    }
}

var initializeForm = function (data, tags, editUrl) {
    /*  Main controller.
        Called by readRecordData with results of api-call */
    console.log( "in initializeForm(); data: ", data );
    console.log( "in initializeForm(); tags: ", tags );
    console.log( "in initializeForm(); editUrl: ", editUrl );
    setFormHeader(data['rec']);
    setInputValues(data['rec']);

    // Populate entrants table

    if (data['entrants'].length > 0) {
      document.getElementById('entrants-table').hidden = false;
      for (var i=0; i < data['entrants'].length; i++ ) {
        console.log( "in initializeForm(); about to call addEntrantInput() with data: ", data['entrants'][i] );
        addEntrantInput(
          $('#entrants'), data['entrants'][i], tags
        );
      }
    }

    initiateEntrantWorkflow( $('#entrant_component'), editUrl );

    // GROUPS - START

    // Populate groups table
    //  Unhide groups table if there are entries

    document.getElementById('groups-table').hidden = !(data.groups.group_data.length > 0);

    const groupListingTemplate = document.getElementById('groups-template'),
          groupListingContainer = document.getElementById('groups-table');

    // Function to create a group listing in DOM
    //  Make a copy of the template, populate it
    //  Add event listeners for buttons
    //  Append populated template-copy to DOM

    function createGroupListingFromData(groupEntry) {

      const groupListing = groupListingTemplate.content.cloneNode(true);

      // Populate fields with values

      groupListing.querySelectorAll('.groups-id').forEach(
        groupIdField => {
          // groupIdField.href=`/data/reference_group/${groupEntry.uuid}/`;
          groupIdField.href = "{% url 'data_group_url' 'STUB' %}".replace( 'STUB', groupEntry.uuid );
          groupIdField.innerHTML = groupEntry.uuid ? groupEntry.uuid.substr(0,7) : '';
          groupIdField.setAttribute('data-uuid', groupEntry.uuid || '');
          groupIdField.addEventListener('click', copyUUIDtoClipboard);
        }
      );

      groupListing.querySelectorAll('.groups-description').forEach(
        groupDescriptionField => groupDescriptionField.value = groupEntry.description
      );

      groupListing.querySelectorAll('.groups-count').forEach(
        groupCountField => groupCountField.value = groupEntry.count
      );

      groupListing.querySelectorAll('.groups-count-estimated').forEach(
        groupCountEstimatedCheckbox => groupCountEstimatedCheckbox.checked = groupEntry.count_estimated
      );

      // Set up event handlers

      // First, gather references to form

      const ENTRY_CONTAINER_CLASS_NAMES = ['group-display-entry', 'group-edit-entry'],
            FIELD_CLASS_NAMES = ['groups-description', 'groups-count', 'groups-count-estimated', 'groups-id'];

      function gatherEntries(rowAcc, rowClassName) {
        let fieldsHash = {};
        FIELD_CLASS_NAMES.forEach(fieldClassName => {
          fieldsHash[fieldClassName] = groupListing.querySelector(`.${rowClassName} .${fieldClassName}`)
        });
        rowAcc[rowClassName] = fieldsHash;
        return rowAcc;
      }

      // fields holds references to DOM nodes by classname

      const fields = ENTRY_CONTAINER_CLASS_NAMES.reduce(gatherEntries, {});

      console.log('FIELDS', fields);

      const tbodyContainer = groupListing.querySelector('tbody'),
            editRow = groupListing.querySelector('.group-edit-entry'),
            savingStateClassList = groupListing.querySelector('.group-save-state').classList,
            setIsCurrentlySaving = (s) => savingStateClassList[s ? 'add' : 'remove']('group-currently-saving');

      // two functions to copy values to/from the edit and display copies of
      //   the group form

      function copyFromDisplayToEdit(fieldClassName, prop) {
        fields[`group-edit-entry`][fieldClassName][prop] = fields[`group-display-entry`][fieldClassName][prop];
      }

      function copyFromEditToDisplay(fieldClassName, prop) {
        fields[`group-display-entry`][fieldClassName][prop] = fields[`group-edit-entry`][fieldClassName][prop];
      }

      // onClick for group edit button

      function onEditClick(event) {
        tbodyContainer.classList.add('group-edit-mode');
        copyFromDisplayToEdit('groups-description', 'value');
        copyFromDisplayToEdit('groups-count', 'value');
        copyFromDisplayToEdit('groups-count-estimated', 'checked');
      };

      groupListing.querySelectorAll('.click-to-edit-group').forEach(
        clickToEdit => clickToEdit.addEventListener('click', onEditClick)
      );

      // onClick for group cancel edit button

      groupListing.querySelector('.cancel-group').addEventListener('click', (event) => {
        tbodyContainer.classList.remove('group-edit-mode');
      });

      // onClick for group save edit button:
      //  send the data to the server, then copy data from edit form to display form
      //  and hide the edit form

      groupListing.querySelector('.save-group').addEventListener('click', (event) => {

        setIsCurrentlySaving(true);
        const onSaveComplete = (uuid) => {

          if (!fields['group-edit-entry']['groups-id'].getAttribute('data-uuid')) {
            [fields['group-edit-entry'], fields['group-display-entry']].forEach(entry => {
              entry['groups-id'].innerText = uuid.substr(0,7);
              entry['groups-id'].setAttribute('data-uuid', uuid);
              entry['groups-id'].href = `/data/reference_group/${uuid}`;
            });
          }

          copyFromEditToDisplay('groups-description', 'value');
          copyFromEditToDisplay('groups-count', 'value');
          copyFromEditToDisplay('groups-count-estimated', 'checked');
          tbodyContainer.classList.remove('group-edit-mode');
          setIsCurrentlySaving(false);
        }
        saveGroup(fields, onSaveComplete);
      });

      // onClick handler for group delete button

      groupListing.querySelector('.del-group').addEventListener('click', event => {
        const onDeleteComplete = () => {
          console.log('DELETED, now hide', tbodyContainer);
          tbodyContainer.hidden = true;
        };
        deleteGroup(fields, onDeleteComplete);
      });

      // Append to document

      groupListingContainer.appendChild(groupListing);
    } // End createGroupListingFromData()

    // Create a row in table for each entry in the data
    data.groups.group_data
      .sort((a, b) => (a.date_created < b.date_created) ? -1 : 1)
      .forEach(
        groupData => createGroupListingFromData(groupData)
      );

    // onClick for new group

    const NEW_GROUP_DATA = {
      description: null,
      count: 0,
      countEstimated: false
    };

    Array.from(document.getElementsByClassName('add-group-selector')).forEach(
      addGroupButton => addGroupButton.addEventListener(
        'click',
        () => {
          document.getElementById('groups-table').hidden = false;
          createGroupListingFromData(NEW_GROUP_DATA);
          // @todo get into edit mode
        }
      )
    );
}

// const csrf_token = '{{ csrf_token }}';

// Save group to server

function saveGroup(fields, onSaveComplete) {

  const saveData = fields['group-edit-entry'],
        uuid = saveData['groups-id'].getAttribute('data-uuid'),
        isNewGroup = (uuid === ''),
        groupData = {
          count: parseInt(saveData['groups-count'].value),
          count_estimated: saveData['groups-count-estimated'].checked,
          description: saveData['groups-description'].value,
          reference_id: parseInt(getRecId())
        };

  // const groupApiUrl = isNewGroup ? '/data/reference_group/new/' : `/data/reference_group/${uuid}/`;
  // console.log( "groupApiUrl, ", groupApiUrl );

  let groupApiUrl = "init";
  if (isNewGroup) {
    groupApiUrl = "{% url 'data_group_url' 'new' %}";
  } else {
    groupApiUrl = "{% url 'data_group_url' 'STUB' %}".replace( 'STUB', uuid );
  }
  console.log( "saveGroup() groupApiUrl, ", groupApiUrl );

  console.log('SAVE', {
    method: (isNewGroup ? 'POST' : 'PUT'),
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify(groupData),
    credentials: 'same-origin'
  });

  fetch(groupApiUrl, {
    method: (isNewGroup ? 'POST' : 'PUT'),
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify(groupData),
    credentials: 'same-origin'
  }).then(response => {
    response.json().then(data => {
      // console.log(data.response.group_data.uuid);
      onSaveComplete(data.response.group_data.uuid);
    });
  });
}

function deleteGroup(fields, onDeleteComplete) {

  const uuid = fields['group-edit-entry']['groups-id'].getAttribute('data-uuid'),
        // groupApiUrl = `/data/reference_group/${uuid}/`,
        confirmDeleteButton = document.getElementById('confirmDelete-yes'),
        cancelDeleteButton = document.getElementById('confirmDelete-no');

  // const uuid = fields['group-edit-entry']['groups-id'].getAttribute('data-uuid'),
  //       groupApiUrl = `/data/reference_group/${uuid}/`,
  //       confirmDeleteButton = document.getElementById('confirmDelete-yes'),
  //       cancelDeleteButton = document.getElementById('confirmDelete-no');

  const groupApiUrl = "{% url 'data_group_url' 'STUB' %}".replace( 'STUB', uuid );
  console.log( "deleteGroup() groupApiUrl, ", groupApiUrl );

  const onConfirmDelete = function() {
    console.log('REALLY REALLY DELETING ' + groupApiUrl);

    fetch(groupApiUrl, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: '',
      credentials: 'same-origin',
    }).then(onDeleteComplete);
  }

  // Clear all event listeners out of confirm button

  const confirmDeleteButtonClone = confirmDeleteButton.cloneNode(true);
  confirmDeleteButton.parentNode.replaceChild(confirmDeleteButtonClone, confirmDeleteButton);
  confirmDeleteButtonClone.addEventListener('click', onConfirmDelete, true);


}

// GROUPS - END

var readRecordData = function(recId, roles, edit_url) {
    /*  Bridge to main controller (initializeForm).
        Called by document.ready() */
    // var rec_data_api = "{% url 'data_record_url' rec_id=recId %}";  // this should work; grr...
    var rec_id = recId;
    console.log( "rec_id: ", rec_id );
    {% if rec_id %}
        var rec_data_api = "{% url 'data_record_url' rec_id %}";  // yes, needing the var is a little crazy; grr...
    {% else %}
        var rec_data_api = "{% url 'data_record_url' %}?doc_id={{ doc_id }}";
    {% endif %}
    console.log( "in `var readRecordData`; rec_data_api: ", rec_data_api );
    var out = null;
    $.get(rec_data_api, function(data) {
        initializeForm(data, roles, edit_url);
    });
}

var updateRecordData = function(recId, docId) {

    console.log( "in var updateRecordData, recId: ", recId );
    console.log( "in var updateRecordData, docId: ", docId );

    var rec_id = recId;
    var rec_data_api = "{% url 'data_record_url' rec_id %}";
    console.log( "in updateRecordData(); rec_data_api, ", rec_data_api );

    console.log( "rec_id: ", rec_id );
    {% if rec_id %}
        var rec_data_api = "{% url 'data_record_url' rec_id %}";  // yes, needing the var is a little crazy; grr...
    {% else %}
        var rec_data_api = "{% url 'data_record_url' %}";
    {% endif %}
    console.log( "in `var updateRecordData`; rec_data_api: ", rec_data_api );

    var data = collectInputValues(docId);
    console.log( "collectInputValues data: ", data );
    var method = (recId ? "PUT" : "POST");
    console.log( "method: ", method );

    $.ajax({
        type: method,
        url: rec_data_api,
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function(data) {
            if ( method === 'POST' ) {
                console.log( "in var updateRecordData; redirecting to: ", data.redirect );
                window.location.href = data.redirect;
            } else {
                console.log( "in var updateRecordData; about to call setInputValues()" );
                setInputValues(data.rec);
                $('#record_form').accordion('option','active', false );
            }
        }
    });
}

var addEntrantInput = function($container, entData, tags) {
    console.log( "in `var addEntrantInput`; entData: ", entData );
    var $tr, $td1, $td2, $td3, $td4,
        $input1, $input2, $select,
        $button, $span;

    $tr = $('<tr/>', { 'class': 'entrant-row',
        'data-ent-id': entData['id'],
        'data-name-id': entData['name_id']});
    $td1 = $('<td/>', {'class': 'person-id',
        'html': entData['person_id']});
    $td2 = $('<td/>');
    $td3 = $('<td/>');
    $td4 = $('<td/>');
    $td5 = $('<td/>', { 'class': 'entrant-controls'});
    $input1 = $('<input/>', {
        'class': 'form-control entrant-input name-first',
        'type': 'text',
        'value': entData['first'] });
    $input2 = $('<input/>', {
        'class': 'form-control entrant-input name-last',
        'type': 'text',
        'value': entData['last'] });
    $select = $('<select/>',
        { 'class': 'form-control entrant-input role-tags'});

    for (var i = 0; i < tags.length; i++) {
        var opt = tags[i];
        var $opt = $("<option/>", { 'value': opt.id ,
                                    'text': opt.value });
        $select.append($opt);
    }
    $td2.append($input1);
    $td3.append($input2);
    $td4.append($select);
    $td5.append($button);
    $tr.append($td1).append($td2).append($td3).append($td4).append($td5);
    $container.append($tr);

    $select.prop("multiple", true);
    $select.select2({
        tags: true,
    });

    $select.val(entData['roles']);
    $select.trigger('change');

    return $container;
}

var makeEntrantEditable = function ($container, entId) {
    $active = $container.find($(`.entrant-row[data-ent-id=${entId}]`));

    $save_btn = $('<button/>', {
        'class': 'btn btn-primary save-entrant entrant-ctl',
        'save-entrant-id': entId,
        'title': 'Save changes',
        'text': 'Save' });
    // $save_span = $('<span/>', {'class': 'fas fa-check-circle'});

    $del_btn = $('<button/>', {
        'class': 'btn btn-danger del-entrant entrant-ctl',
        'del-entrant-id': entId,
        'title': 'Delete entry for this person',
        'text': 'Delete individual' });

    // $del_span = $('<span/>', {'class': 'fas fa-times-circle'});

    //$save_btn.append($save_span);
    //$del_btn.append($del_span);

    $active.find($('.form-control')).prop('disabled', false);

    if (entId !== 'new') {
        $cancel_btn = $('<button/>', {
            'class': 'btn btn-secondary cancel-entrant entrant-ctl',
            'title': 'Cancel current changes',
            'text': 'Undo changes'
        });
        //$cancel_span = $('<span/>', {'class': 'fas fa-undo'});
        //$cancel_btn.append($cancel_span);

        $active.find($('.entrant-controls')).append($cancel_btn)
    } else {
      $cancel_btn = $('');
    }

    $active.find($('.entrant-controls'))
           .append($save_btn)
           .append($cancel_btn)
           .append($del_btn);

    return $container;
}

var initiateEntrantWorkflow = function ($container, editUrl) {
    console.log( "editUrl, ", editUrl )
    var $rows = $container.find('.entrant-row');
    var $btn = $container.find('#add-person');
    $rows.each( function( idx ) {
        var ent_id = $(this).attr('data-ent-id');
        var $details_btn = $('<a/>', { 'class': 'btn btn-secondary details-entrant entrant-ctl',
            'text': 'Details',
            // 'href': `${editUrl}/${ent_id}`
            'href': `${editUrl}${ent_id}`
            } );
        var $merge_btn = $('<button/>', { 'class': 'btn btn-warning merge-entrant entrant-ctl',
            'hidden': 'hidden',
            'text': 'Merge'});
        var $edit_btn = $('<button/>', { 'class': 'btn btn-primary edit-entrant entrant-ctl',
            'text': 'Edit'});
        $row = deactivateEntrantInput( $(this) );
        $row.find($('.entrant-controls')).append($details_btn)
            .append($merge_btn).append($edit_btn);
    });
    activateButton( $btn );
}

var deactivateEntrantInput = function ($row) {
    $row.find($('.entrant-input')).each( function(idx) {
        $( this ).prop('disabled', true);
    });
    $row.find($('.entrant-controls')).empty();
    return $row;
}

var activateButton = function ( $button ) {
    $button.prop('disabled', false);
}

var deactivateButton = function ( $button ) {
    $button.prop('disabled', true);
}

var deleteEntrant = function($container, entId, editUrl ) {
    {# var ent_data_api = "{{ url_for('update_referent', rntId=None )}}" + entId; #}
    var ent_data_api = "{% url 'data_referent_url' 'STUB' %}".replace( 'STUB', entId );
    console.log( "ent_data_api for deleteEntrant, ```" + ent_data_api + "```" );
    $.ajax({
        type: "DELETE",
        url: ent_data_api,
        contentType: "application/json",
        success: function(data) {
            deleteEntrantRow($container, data['id'], editUrl);
        }
    });
}

var updateEntrant = function($container, entId, entData, editUrl) {
    console.log( "entId for updateEntrant, ", entId );
    var method,
        {% comment %} ent_data_api = "{{ url_for('update_referent', rntId=None )}}"; {% endcomment %}
        ent_data_api = "{% url 'data_referent_url' 'STUB' %}".replace( 'STUB', entId );
    console.log( "ent_data_api for updateEntrant(), ```" + ent_data_api + "```" );
    if (entId === 'new') {
        method = 'POST';
    } else {
        // ent_data_api = ent_data_api + entId;
        method = 'PUT';
    }

    console.log('DATA BEING SUBMITTED', JSON.stringify(entData));

    $.ajax({
        type: method,
        url: ent_data_api,
        data: JSON.stringify(entData),
        contentType: "application/json",
        success: function(data) {
            updateEntrantRow($container, data, entId, editUrl);
        }
    });
}

var updateEntrantRow = function ($container, entData, entId, editUrl ) {
    var $row, $select;
    $row = $container.find(`.entrant-row[data-ent-id=${entId}]`);
    $row.attr('data-ent-id', entData['id']);
    $row.attr('data-name-id', entData['name_id']);
    $row.find('.person-id').html(entData['person_id']);
    $row.find('.name-first').val(entData['first']);
    $row.find('.name-last').val(entData['last']);
    $select = $row.find('.role-tags');
    $select.val(entData['roles']);
    $select.trigger('change')

    initiateEntrantWorkflow($container, editUrl);
    return $container;
}

var deleteEntrantRow = function ($container, entId, editUrl ) {
    $container.find(`.entrant-row[data-ent-id=${entId}]`).remove();
    initiateEntrantWorkflow($container, editUrl);
    return $container;
}

var deactivateEntrantEditing = function ($container) {
    var $rows = $container.find('.entrant-row');
    var $btn = $container.find('#add-person');
    $rows.each( function( idx ) {
        deactivateEntrantInput( $(this) );
    });
    deactivateButton( $btn );

    return $container
}

var getAttributeData = function( $container ) {
    var att_data = [];
    $opts = $container.find(':selected');
    $opts.each( function(idx) {
        var $opt = $( this );
        var data = {};
        data['id'] = $opt.val();
        data['name'] = $opt.text();
        att_data.push(data);
    });

    return att_data;
}

var getEntrantData = function($container, entId, recId) {
    var $row = $container.find(`.entrant-row[data-ent-id=${entId}]`);
    var data = { 'name': {} };
    data['id'] = $row.attr('data-ent-id');
    data['record_id'] = recId;
    data['name']['id'] = $row.attr('data-name-id');
    data['name']['first'] = $row.find('.name-first').val();
    data['name']['last'] = $row.find('.name-last').val();
    data['roles'] = getAttributeData($row.find('.role-tags'));

    return data;
}

$( document ).ready(function() {

    console.log( "starting document.ready()" );

    var doc_id = getDocumentId();

    var rec_id = getRecId();
    console.log( "in document.ready(); rec_id: ", rec_id );

    {% comment %} var details_url = "{{ url_for('edit_entrant', entId=None)}}"; {% endcomment %}
    var details_url = "{% url 'edit_person_root_url' %}";
    console.log( "in document.ready(); details_url, ```" + details_url + "```" );

    {% comment %} var roles = JSON.parse('{{ roles | tojson | safe}}'); {% endcomment %}
    {% comment %}
    <!-- json_script filter added in django-2.1 -->
    {{ roles|json_script:"roles_id" }}
    var roles = JSON.parse( document.getElementById('roles_id').textContent );
    {% endcomment %}
    var roles = JSON.parse('{{ roles | safe}}');
    console.log( "in document.ready(); roles: ", roles );

    // Add formatting controls to transcription field
    // (uses tinyMCE https://www.tiny.cloud/)

    tinymce.init({
        selector: '#transcription',
        menubar: false,
        toolbar: false,
        plugins: ['quickbars'],
        quickbars_selection_toolbar: 'bold italic underline',
        contextmenu: 'bold italic underline',
        width: '100%'
    });

    $('#recordtype_autocomplete').autocomplete({
        source: JSON.parse('{{ rec_types | safe}}'),
        minLength: 0,
        delay: 5,
        autoFocus: true,
        response: function (event, ui) {

            if (ui.content.length == 0) {
                ui.content.push({
                    label: $(this).val(),
                    value: $(this).val(),
                    id: -1
                });
            }
        },
        change: function (event, ui) {
            updateRecordType($('#recordtype_autocomplete'), ui.item);
        }
    });

    {% comment %} addNationalContextOptions(JSON.parse('{{ natl_ctxs | tojson | safe}}')); {% endcomment %}
    addNationalContextOptions(JSON.parse('{{ natl_ctxs | safe}}'));

    $('#col_state_autocomplete').autocomplete({
        source: JSON.parse('{{ col_state | safe}}'),
        minLength: 1,
        delay: 10,
        autoFocus: true,
        response: function (event, ui) {
            if (ui.content.length == 0) {
                ui.content.push({
                    label: $(this).val(),
                    value: $(this).val(),
                    id: -1
                });
            }
        },
        change: function (event, ui) {
            updateLocationInput($('#col_state_autocomplete'), ui.item);
        }
    });


    $('#town_autocomplete').autocomplete({
        // source: JSON.parse( {{ towns | safe}} ),
        source: JSON.parse( document.getElementById('towns_id').textContent ),
        minLength: 1,
        delay: 10,
        autoFocus: true,
        response: function (event, ui) {
            if (ui.content.length == 0) {
                ui.content.push({
                    label: $(this).val(),
                    value: $(this).val(),
                    id: -1
                });
            }
        },
        change: function (event, ui) {
            updateLocationInput($('#town_autocomplete'), ui.item);
        }
    });

    $('#addl_loc_autocomplete').autocomplete({
        // {% comment %} source: JSON.parse('{{ addl_loc | tojson | safe}}'), {% endcomment %}
        source: JSON.parse( document.getElementById('addl_loc_id').textContent ),
        minLength: 1,
        delay: 10,
        autoFocus: true,
        response: function (event, ui) {
            if (ui.content.length == 0) {
                ui.content.push({
                    label: $(this).val(),
                    value: $(this).val(),
                    id: -1
                });
            }
        },
        change: function (event, ui) {
            updateLocationInput($('#addl_loc_autocomplete'), ui.item);
        }
    });

    $( "#record_form" ).accordion({
        collapsible: true,
        header: "h2",
        heightStyle: 'content',
        active: (rec_id ? false : 0)
    });

    $( "#record_date" ).datepicker({
      defaultDate: "01/01/1492",
      changeMonth: true,
      changeYear: true,
      yearRange: "1491:2000"
    });

    $("#rec_update").on('click', function(e) {
        console.log( "starting rec_update handling" );
        e.preventDefault();
        console.log( "hereA" );
        if ( $(this).attr('data-clicked') == 1 ) {
            console.log( "hereB" );
            $(this).attr('data-clicked', 0);
            console.log( "hereC" );
            return true;
        } else {
            console.log( "hereD" );
            $(this).attr('data-clicked', 1);
            console.log( "hereE" );
            tinymce.triggerSave();
            console.log( "hereF" );
            updateRecordData(rec_id, doc_id);
        }
    });

    $('#entrant_component').on('click', '#add-person', function(e) {
        console.log( "handling click of `add-person`" );
        document.getElementById('entrants-table').hidden = false;
        e.preventDefault();
        var data = { 'id': 'new', 'first': '',
            'last': '', 'roles': [], 'name_id': 'name' };
        addEntrantInput( $('#entrants'), data, roles);
        deactivateEntrantEditing( $('#entrant_component') );
        makeEntrantEditable( $('#entrants'), 'new');
    });

    $('#entrant_component').on('click', '#add-group', function(e) {
        console.log( "handling click of `add-group`" );
        // document.getElementById('entrants-table').hidden = false;
        // e.preventDefault();
        // var data = { 'id': 'new', 'first': '', 'last': '', 'roles': [], 'name_id': 'name' };
        // addEntrantInput( $('#entrants'), data, roles);
        // deactivateEntrantEditing( $('#entrant_component') );
        // makeEntrantEditable( $('#entrants'), 'new');
    });

    $('#entrant_component').on('click', '.edit-entrant', function(e) {
        e.preventDefault();

        var ent_id = $( this ).closest('.entrant-row').attr('data-ent-id');
        deactivateEntrantEditing( $('#entrant_component') );
        makeEntrantEditable( $('#entrants'), ent_id);
    });

    $('#entrant_component').on('click', '.cancel-entrant', function(e) {
        e.preventDefault();

        initiateEntrantWorkflow( $('#entrant_component'), details_url );
    });

    $('#entrant_component').on('click', '.del-entrant', function(e) {

        e.preventDefault();
        var ent_id = $( this ).attr('del-entrant-id');

        if (ent_id === 'new') {
            deleteEntrantRow( $('#entrant_component'), ent_id, details_url );
        } else {
            deleteEntrant( $('#entrant_component'), ent_id, details_url );
        }

        return;
    });

    $('#entrant_component').on('click', '.save-entrant', function(e) {
        console.log( "handling save-entrant" );

        e.preventDefault();
        var ent_id = $( this ).attr('save-entrant-id');
        var data = getEntrantData($('#entrant_component'), ent_id, rec_id);
        updateEntrant( $('#entrant_component'), ent_id, data, details_url );
    });

    console.log( "in document.ready(), near end, about to call readRecordData()" );
    readRecordData(rec_id, roles, details_url);

});
</script>
{% endblock %}
